---
title: "Project 1 Vignette"
author: "DRV"
date: "9/16/2020"
output: rmarkdown::github_document toc: yes
    toc_depth: 4
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

###### Packages required to create this vignette: 
httr, jsonlite, dplyr, ggplot2, knitr

###Contacting API
```{r ContactAPIs, include=TRUE}
library(httr)
library(jsonlite)
library(dplyr)

### Franchise Data 
url1 <- "https://records.nhl.com/site/api/franchise"
call1 <- paste(url1)
get_franchise <- GET(call1)
get_franshise_text <- content(get_franchise, "text")
get_franshise_json <- fromJSON(get_franshise_text, flatten=TRUE)
get_franshise_df <- as.data.frame(get_franshise_json)

### Franchise team Totals 
url2 <- "https://records.nhl.com/site/api/franchise-team-totals"
call2 <- paste(url2)
get_ftt <- GET(call2)
get_ftt_text <- content(get_ftt, "text")
get_ftt_json <- fromJSON(get_ftt_text, flatten=TRUE)
get_ftt_df <- as.data.frame(get_ftt_json)

### All Time Record vs. Franchise 
url3 <- "https://records.nhl.com/site/api/all-time-record-vs-franchise?cayenneExp=teamFranchiseId="
function1 <- function(teamID){paste(url3,teamID,sep="")}
call3 <- function1("1")
get_atrvf <- GET(call3)
get_atrvf_text <- content(get_atrvf, "text")
get_atrvf_json <- fromJSON(get_atrvf_text, flatten=TRUE)
get_atrvf_df <- as.data.frame(get_atrvf_json)

### Franshice Goalie Records 
url4 <- "https://records.nhl.com/site/api/franchise-goalie-records?cayenneExp=franchiseId="
function2 <- function(teamID){paste(url4,teamID,sep="")}
call4 <- function2("1")
get_fgr <- GET(call4)
get_fgr_text <- content(get_fgr, "text")
get_fgr_json <- fromJSON(get_fgr_text, flatten=TRUE)
get_fgr_df <- as.data.frame(get_fgr_json)

### Franchise Skater Records 
url5 <- "https://records.nhl.com/site/api/franchise-skater-records?cayenneExp=franchiseId="
function3 <- function(teamID){paste(url5,teamID, sep="")}
call5 <- function3(1)
get_fsr <- GET(call5)
get_fsr_text <- content(get_fsr, "text")
get_fsr_json <- fromJSON(get_fsr_text, flatten=TRUE)
get_fsr_df <- as.data.frame(get_fsr_json)

### NHL Stats Data 
url6 <- "https://statsapi.web.nhl.com/api/v1/teams/"
function4 <- function(teamID, modifier){paste(url6, teamID, modifier, sep="")}
call6 <- function4("1", "?expand=team.roster")
get_stats <- GET(call6)
get_stats_text <- content(get_stats, "text")
get_stats_json <- fromJSON(get_stats_text, flatten=TRUE)
get_stats_df <- as.data.frame(get_stats_json)
  
### Wrapper Function 

function5 <- function(url, teamID, modifier){
  call7 <- paste(url, teamID, modifier, sep="") 
  get_data <- GET(call7) 
  get_data_text <- content(get_data, "text") 
  get_data_json <- fromJSON(get_data_text, flatten=TRUE) 
  get_data_df <- as.data.frame(get_data_json)
  }

### Testing Wrapper Function
get_data_df <- function5("https://statsapi.web.nhl.com/api/v1/teams/","2","?expand=team.roster")

```
### Exploratory Data Analysis 
# Joining Franchise Team Totals and Franchise Goalie Records on "data.franchiseId" 
```{r EDA, include=TRUE}
joined_data <- inner_join(get_ftt_df, get_fgr_df, by = c("data.franchiseId" =  "data.franchiseId"))
```

# Creating two new variables 
```{r NewVars, include=TRUE}

get_fgr_df <- mutate(get_fgr_df, DepthChart= ifelse(get_fgr_df$data.gamesPlayed > 100, "Starter", "Backup")) 

get_fgr_df <- mutate(get_fgr_df, CareerWP500 = ifelse((get_fgr_df$data.gamesPlayed-get_fgr_df$data.losses)/data.gamesPlayed > .5, "Over500", "Under500"))

```
# Contingency tables 
```{r Contingency include=TRUE}
library(knitr)
firstctable <- table(get_fgr_df$data.activePlayer, get_fgr_df$DepthChart)
kable(firstctable, caption = "Contingency Table for Player Status(Active/Not Active) vs. Experience More/Less than 100 games(Backup/Starter")

secondctable <- table(get_fgr_df$data.gamesPlayed, get_fgr_df$WP500)
kable(secondctable, caption = "Contingency table for Games Played vs. Career WP > .500")
```
# Numerical Summaries for Numerical Variables grouped by Categorical Variables
```{r NumericalSummaries, include=TRUE}
ntable <- get_fgr_df %>% group_by(DepthChart) %>% summarise(avg = mean(data.wins), med = median(data.wins), var = var(data.wins))

kable(ntable)

ntable2 <- get_fgr_df %>% group_by(WP500) %>% summarise(avg = mean(data.mostShutoutsOneSeason), med = median(data.mostShutoutsOneSeason), var = var(data.mostShutoutsOneSeason))

kable(ntable2)
```

# Bar Plot
```{r Bar, include=TRUE}
library(ggplot2)
ggplot(get_fgr_df, aes(x = data.lastName, y = data.mostSavesOneGame, color = data.lastName, fill=data.lastName)) + theme(axis.text.x=element_text(angle=90,hjust=1),legend.position = "none") + geom_col()+ggtitle("Montreal Canadians Goalies - Most Saves In One Game") + xlab("Goalie Last Name") + ylab("Saves in One Game") 

```
# Histogram
```{r Histogram, include=TRUE}
ggplot(get_fgr_df, aes(x = data.mostGoalsAgainstOneGame)) + geom_histogram(bins = 10) + ggtitle("Histogram for Most Goals Against in One Game") 
```

# Box Plot 
```{r BoxPlot, include=TRUE}
library(ggplot2)
ggplot(get_fgr_df, aes(x = WP500, y = data.gamesPlayed)) + geom_boxplot() + 
  geom_jitter(aes(color = WP500)) + ggtitle("Boxplot for WP500") + xlab("Over or below .500 Win %") + ylab("Number of games played in Career")
```

# Scatter Plot 
```{r Scatter, include=TRUE}
ggplot(get_fgr_df, aes(x = data.gamesPlayed, y =((data.gamesPlayed-data.losses)/data.gamesPlayed) , group = WP500)) + geom_point(aes(color = WP500)) +     
   geom_smooth(method = 'lm', color = 'green') + ggtitle("Games played vs. Win Percentage")+ xlab("Games Played in Career") + ylab("Win %")
```

# Final Plot 
```{r Final, include=True}
ggplot(get_fsr_df, aes(x = data.penaltyMinutes, y = data.points, group = data.positionCode)) + geom_point(aes(color = data.positionCode)) +     
   geom_smooth(method = 'lm', color = "red") + ggtitle("Penalty Minutes vs. Points")+ xlab("Penalty Minutes") + ylab("Points")

```
